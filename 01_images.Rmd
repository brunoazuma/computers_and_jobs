---
title: "Images"
output: rmarkdown::github_document
bibliography: ref-mono.bib
csl: associacao-brasileira-de-normas-tecnicas-ipea.csl
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook for the development and saving of the images used in the undergrad thesis. Some images will be developed on my own, some will be replications of cited papers. The notebook will follow the structure of the undergrad thesis.

```{r}
library("dotenv")
library("tidyverse")
library("duckdb")
library("gtsummary")
library("labelled")
library("ggthemes")
```

```{r}
setwd("D:/OneDrive/R Workspace/computers_and_jobs")
load_dot_env()
```

# Introduction

The first image used in the introduction section is a reproduction of @autor2019.

```{r include=FALSE}
source("./Replication data for autor 2019/do/occ_changes_plots_adjusted.R")

# Main Function
df <- as.data.table(read.dta13(data_path))
```

**Changes in Occupational Employment Shares, 1970-2016**

*Working Age Adults (Percent Change Over Decade)*

```{r warning=FALSE}
# Figure 3
plot_occ_group_pct_changes(df,subgroup='overall',subgroup_title='Working Age Adults',
										intervals=c('1970-1980','1980-1990','1990-2000','2000-2016'))
```

# Descriptive statistics

## RAIS and skill classification

First, I'll describe the outcome variables (mean wages and number of jobs) in general and segmented by skill type of the occupation, both for the first period and on average for all periods.

```{r}
datadir <- Sys.getenv("DATA_DIR")
file <- str_interp('${datadir}Final_db.parquet')
temp_db_dir <- Sys.getenv("DUCK_DB_DIR")
temp_db_mem <- Sys.getenv("DUCK_DB_MEM")

con <- dbConnect(duckdb(), dbdir = temp_db_dir)
dbExecute(conn = con, str_interp("PRAGMA memory_limit='${temp_db_mem}'"))
```

```{r}
tictoc::tic()

data <- tbl(con, file) %>%
  group_by(
    ano,
    group
  ) %>%
  summarise(
    valor_remuneracao_media=mean(valor_remuneracao_media),
    valor_remuneracao_media_sm=mean(valor_remuneracao_media_sm),
    mean_wage=mean(mean_wage),
    job_number=sum(job_number)
  ) %>%
  ungroup() %>%
  mutate(
    log_wage = log(mean_wage + 1)
  ) %>%
  collect()

dbDisconnect(con, shutdown=TRUE)

data <- data %>%
  mutate(
    group = as.factor(group) %>% relevel('NRM'),
    ano = as.factor(ano)
  )

tictoc::toc()
data %>% head()
```

Now, I'll add labels to the columns to improve future display.

```{r}
var_label(data) <- list(
  ano = "Year",
  group = "Skill classification",
  mean_wage = "Mean hourly wages (at 2021 prices)",
  job_number = "Number of employment relationships",
  log_wage = "Log of mean hourly wages (at 2021 prices)"
)
```

```{r}
chart1data <- data %>%
  filter(ano!=2020 & ano!=2021) %>%
  filter(!is.na(group)) %>%
  select(ano, mean_wage, job_number) %>%
  group_by(ano) %>%
  summarise_all(mean) %>%
  mutate(
    mean_wage_index = mean_wage/first(mean_wage),
    job_number_index = job_number/first(job_number)
  ) %>%
  ungroup()

chart1data
```

```{r}
chart1data %>%
  ggplot( aes(x=ano, y=mean_wage_index, group=1)) +
    geom_line() +
    # scale_color_viridis(discrete = TRUE) +
    ggtitle("Mean wages") +
		theme_stata() +
    theme(axis.ticks.x = element_blank(), plot.background = element_rect(fill='white'),
          axis.text.x=element_text(angle=-45,size=8,hjust=0),axis.text.y=element_text(angle=0),
          legend.title=element_blank(),legend.background = element_rect(colour='white'))+
    guides(fill=FALSE) +
    ylab("Mean hourly wages (2006=1)") +
    xlab(NULL)
```

```{r}
chart1data %>%
  ggplot( aes(x=ano, y=job_number_index, group=1)) +
    geom_line() +
    # scale_color_viridis(discrete = TRUE) +
    ggtitle("Employment relationships") +
		theme_stata() +
    theme(axis.ticks.x = element_blank(), plot.background = element_rect(fill='white'),
          axis.text.x=element_text(angle=-45,size=8,hjust=0),axis.text.y=element_text(angle=0),
          legend.title=element_blank(),legend.background = element_rect(colour='white'))+
    guides(fill=FALSE) +
    ylab("Number of employment relationships (2006=1)") +
    xlab(NULL)
```

```{r}
chart2data <- data %>%
  filter(ano!=2020 & ano!=2021) %>%
  select(group, ano, mean_wage, job_number) %>%
  group_by(group, ano) %>%
  summarise_all(mean) %>%
  mutate(
    mean_wage_index = mean_wage/first(mean_wage),
    job_number_index = job_number/first(job_number)
  ) %>%
  ungroup()

chart2data
```

```{r}
chart2data %>%
  filter(!is.na(group)) %>%
  ggplot( aes(x=ano, y=mean_wage_index, group=group, color=group)) +
    geom_line() +
    # scale_color_viridis(discrete = TRUE) +
    ggtitle("Mean wages by skill group") +
		theme_stata() +
    theme(axis.ticks.x = element_blank(), plot.background = element_rect(fill='white'),
          axis.text.x=element_text(angle=-45,size=8,hjust=0),axis.text.y=element_text(angle=0),
          legend.title=element_blank(),legend.background = element_rect(colour='white'))+
												guides(fill=FALSE) +
    ylab("Mean hourly wages (2006=1)") +
    xlab(NULL)
```

```{r}
chart2data %>%
  filter(!is.na(group)) %>%
  ggplot( aes(x=ano, y=job_number_index, group=group, color=group)) +
    geom_line() +
    # scale_color_viridis(discrete = TRUE) +
    ggtitle("Employment relationships") +
		theme_stata() +
    theme(axis.ticks.x = element_blank(), plot.background = element_rect(fill='white'),
          axis.text.x=element_text(angle=-45,size=8,hjust=0),axis.text.y=element_text(angle=0),
          legend.title=element_blank(),legend.background = element_rect(colour='white'))+
												guides(fill=FALSE) +
    ylab("Number of employment relationships (2006=1)") +
    xlab(NULL)
```

```{r}
chart3data <- data %>%
  filter(ano %in% seq(2006, 2018, 2)) %>%
  filter(!is.na(group)) %>%
  group_by(group) %>%
  arrange(ano, .by_group = TRUE) %>%
  mutate(
    delta_job_number = job_number/lag(job_number) - 1,
    interval = paste(lag(ano), ano, sep = '-'),
    mean_wage_2006 = sum(mean_wage*as.integer(ano==2006))
  ) %>%
  ungroup() %>%
  filter(ano != 2006) %>%
  select(interval, group, delta_job_number, mean_wage_2006) %>%
  arrange(mean_wage_2006, interval) %>%
  mutate(
    order=seq(1, 24)
  )

chart3data
```

```{r}
chart3data %>% ggplot(aes(x=reorder(group, order),y=delta_job_number,fill=group,alpha=interval))+
											geom_bar(stat='identity',position='dodge')+
											scale_alpha_discrete(range=seq(.5,1,.1),labels=paste(unique(chart3data$interval),' '))+theme_stata()+
											labs(x='',y='Change (% pts)')+
											scale_fill_manual(values=c('#d7191c','#fdae61','#4de678','#2c7bb6'))+
											theme(axis.ticks.x = element_blank(), plot.background = element_rect(fill='white'),
												axis.text.x=element_text(angle=-45,size=8,hjust=0),axis.text.y=element_text(angle=0),
												legend.title=element_blank(),legend.background = element_rect(colour='white'))+
												guides(fill=FALSE)
```

# References
