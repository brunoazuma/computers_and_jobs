---
title: "Computers and jobs - Merging of RAIS, CNAE and CBO"
output: rmarkdown::github_document
bibliography: ref-mono.bib
csl: associacao-brasileira-de-normas-tecnicas-ipea.csl
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook for the exploratory analysis and preparation of data from the Classificação Nacional das Atividades Econômicas (CNAE), managed by Instituto Brasileiro de Geografia e Estatística (IBGE), as made available by [Base dos Dados](https://basedosdados.org/).

```{r}
setwd("D:/OneDrive/R Workspace/computers_and_jobs")
# install.packages(\"dotenv\")
library("dotenv")
# install.packages('arrow')
library(arrow, warn.conflicts = FALSE)
# install.packages("tidyverse")
library("tidyverse")
```


```{r}
base_datadir <- "./data/"
rais_datadir <- str_interp("${base_datadir}RAIS/reduced/")
```

```{r}
cbo <- read_parquet(str_interp("${base_datadir}CBO.parquet"))
cnae <- read_parquet(str_interp("${base_datadir}CNAE.parquet"))
```


```{r}
ufs <- read_parquet(str_interp("${base_datadir}UFs.parquet"))
years <- seq(2006,2021)
```

```{r}
print('Starting aggregation')
print(Sys.time())
rais_merged <- NULL

for (year in years) {
  print(str_interp("Starting aggregation for year ${year}..."))
  for (uf in ufs$sigla) {
    if (uf == "SP") {
      next
    }
    file <- str_interp("${rais_datadir}RAIS_${year}_${uf}.parquet")
    print(str_interp("Reading ${file}..."))
    rais_ <- read_parquet(file)
    
    rais_ <- rais_ %>%
      left_join(
        cbo,
        by=join_by(cbo_2002==cbo_2002)
      ) %>%
      left_join(
        cnae,
        by=join_by(cnae_2==cnae_2)
      ) %>%
      group_by(
        ano,
        sigla_uf,
        secao,
        descricao_secao,
        group,
        grau_instrucao_apos_2005,
        sexo,
        raca_cor
      ) %>%
      summarise(
        valor_remuneracao_media=mean(valor_remuneracao_media),
        valor_remuneracao_media_sm=mean(valor_remuneracao_media_sm),
        job_number=n()
      ) %>%
      ungroup
    
    if (is.null(rais_merged)) {
      rais_merged <- rais_
    } else {
      rais_merged <- bind_rows(rais_merged, rais_)
    }
    print(str_interp("${file} has been read."))
    print(Sys.time())
  }
  print(str_interp("Year ${year} has been read."))
  print(Sys.time())
}
print('Ending aggregation')
print(Sys.time())

rais_merged
```

```{r}
rc_share <- rais_merged %>%
  filter(ano==2006 & !is.na(group)) %>%
  mutate(
    rc_job_number=(group=="RC")*job_number
  ) %>%
  group_by(secao) %>%
  summarise(
    rc_job_number=sum(rc_job_number),
    job_number=sum(job_number),
    rc_share=rc_job_number/job_number
  ) %>%
  ungroup

rc_share
```

```{r}
rais_merged <- rais_merged %>%
  left_join(
    rc_share %>% select(secao, rc_share),
    by=join_by(secao==secao)
  )

rais_merged
```


```{r}
write_parquet(rais_merged, str_interp("${base_datadir}/RAIS.parquet"))
```

