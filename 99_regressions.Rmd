---
title: "Computers and jobs - Regressions"
output: rmarkdown::github_document
bibliography: ref-mono.bib
csl: associacao-brasileira-de-normas-tecnicas-ipea.csl
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*.

```{r}
setwd("D:/OneDrive/R Workspace/computers_and_jobs")
# install.packages(\"dotenv\")
library("dotenv")
# install.packages('arrow')
library(arrow, warn.conflicts = FALSE)
# install.packages("basedosdados")
library("basedosdados")
# install.packages("tidyverse")
library("tidyverse")
if(!require(gtsummary)){install.packages('gtsummary');require(gtsummary)}
if(!require(plm)){install.packages("plm");require(plm)}
```

```{r}
datadir <- 'data/'
file <- str_interp('${datadir}RAIS_AGG.parquet')
```

```{r}
rais <- read_parquet(file)
```

```{r}
file <- str_interp('${datadir}/WITS/WITS_trades.parquet')
wits <- read_parquet(file)
```

```{r}
export_share <- wits %>%
  group_by(year) %>%
  summarise(
    quantity=sum(Quantity)
  ) %>%
  ungroup %>%
  mutate(
    x_share = quantity/first(quantity)
  )
```

```{r}
rc_share <- rais %>%
  filter(ano==2006 & !is.na(group)) %>%
  mutate(
    rc_job_number=(group=="RC")*job_number
  ) %>%
  group_by(secao) %>%
  summarise(
    rc_job_number=sum(rc_job_number),
    job_number=sum(job_number),
    rc_share=rc_job_number/job_number
  ) %>%
  ungroup()

rc_share
```


```{r}
rais <- rais %>%
  left_join(
    rc_share %>% select(secao, rc_share),
    by=join_by(secao==secao)
  ) %>%
  left_join(
    export_share %>% select(year, x_share),
    by=join_by(ano==year)) %>%
  mutate(
    exposure=rc_share*x_share
  )
gc()

rais
```

```{r}

rais <- rais %>%
  mutate(
    log_remuneracao_media = log(valor_remuneracao_media + 1),
    sigla_uf = as.factor(sigla_uf),
    cd_secao = secao,
    secao = as.factor(descricao_secao),
    group = as.factor(group) %>% reorder(c('NRM', 'RM', 'RC', 'NRC')),
    grau_instrucao_apos_2005 = as.factor(grau_instrucao_apos_2005),
    sexo = as.factor(sexo),
    raca_cor = as.factor(raca_cor),
    ano = as.factor(ano)
  )
gc()

rais
```

```{r}

tbl_padrao <- function(model, include, label, robust=NULL) {
  tb <- tbl_regression(
    model,
    include = include,
    label = label,
    intercept=TRUE,
    estimate_fun = function(x) style_number(x, digits = 4)
    ) 
  if(!is.null(robust)) {
    tb <- tbl_regression(
      model,
      include = include,
      label = label,
      intercept=TRUE,
      estimate_fun = function(x) style_number(x, digits = 4),
      tidy_fun = partial(tidy_robust, vcov = robust)
      )
  }
  
    tb <- tb %>%
    bold_labels() %>%
    add_significance_stars(
      hide_se = TRUE,
      hide_p=FALSE,
      pattern = '{estimate}{stars} \n({std.error})'
    ) %>%
    # modify_header(
    #   estimate ~ '**Coef. \n(EP)**',
    #   p.value ~ 'p-valor'
    #   ) %>%
    # modify_footnote(estimate ~ "EP = Erro padrão", abbreviation = TRUE) %>%
    add_glance_table(
      include=c(
        'r.squared',
        'adj.r.squared',
        'nobs'
      )
    )

  return(tb)
}
```

# First specification - reproduction of @nber30400

Primeiro, tentarei reproduzir a mesma análise de @nber30400, sem levar em conta o tipo de tarefa predominante por ocupação. Para isso, preciso primeiro agregar os dados.

```{r}
nber30400 <- rais %>%
  group_by(secao, ano) %>%
  summarise(
    valor_remuneracao_media = mean(valor_remuneracao_media),
    exposure = mean(exposure)
  ) %>%
  mutate(
    log_remuneracao_media = log(valor_remuneracao_media)
  ) %>%
  ungroup() %>%
  filter(!is.na(secao) & !is.na(ano))

nber30400
```
Now, I regress exposure on log_remuneracao_media with plm.

```{r}
twfe_reg <- plm(log_remuneracao_media ~ exposure,
             data = nber30400,
             model = 'within',
             effect = 'twoways',
             index = c('secao','ano'))
```

```{r}
tb1 <- tbl_padrao(
  twfe_reg,
  c('exposure'),
  list(exposure='Exposure to computers'),
  robust=TRUE
  )
tb1
```
The results show that the `Exposure to computers` measure alone does not explain any variation in the log wage of the brazilian formal market, both by the non significant result for the variable itself and by the $R^2$ regression.

# Second specification - adding occupation classification

```{r}
data2 <- rais %>%
  filter(
    !is.na(secao) & !is.na(ano) & !is.na(group)
  ) %>%
  group_by(
    secao,
    ano,
    group
  ) %>%
  summarise(
    wage=mean(valor_remuneracao_media),
    exposure=mean(exposure)
  ) %>%
  ungroup %>%
  mutate(
    log_wage = log(wage),
    id = factor(paste(secao, group, sep="-"))
  )

data2
```

```{r}
twfe_reg_2 <- plm(log_wage ~ exposure,
             data = data2,
             model = 'within',
             effect = 'twoways',
             index = c('id','ano'))
```

```{r}
tb2 <- tbl_padrao(
  twfe_reg_2,
  c('exposure'),
  list(exposure='Exposure to computers'),
  robust=TRUE
  )
tb2
```

# Interacting group with exposure

```{r}
twfe_reg_3 <- plm(log_wage ~ exposure:group,
             data = data2,
             model = 'within',
             effect = 'twoways',
             index = c('id','ano'))
```

```{r}
tb3 <- tbl_padrao(
  twfe_reg_3,
  c('exposure:group'),
  list(`exposure:group`='Exposure to computers'),
  robust=TRUE
  )
tb3
```

# Using goup as an explainable variable

## only group as explainable variables

```{r}
twfe_reg_4 <- plm(log_wage ~ group,
             data = data2,
             model = 'within',
             effect = 'time',
             index = c('id', 'ano'))
```

```{r}
tb4 <- tbl_padrao(
  twfe_reg_4,
  c('group'),
  list(
    group='Discrete classification of occupation'
  ),
  robust=TRUE
  )
tb4
```

## group and secao as explainable variables

```{r}
twfe_reg_5 <- plm(log_wage ~ group + secao,
             data = data2,
             model = 'within',
             effect = 'time',
             index = c('id', 'ano'))
```

```{r}
```

```{r}
tb5 <- tbl_padrao(
  twfe_reg_5,
  c('group', 'secao'),
  list(
    group='Discrete classification of occupation',
    secao='CNAE seção'
  ),
  robust=TRUE
  )

tb5
```

```{r}

```

